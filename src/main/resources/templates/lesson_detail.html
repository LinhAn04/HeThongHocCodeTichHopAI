<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${lesson.tieuDeBaiHoc} + ' - ' + ${course.tenKhoaHoc}">Lesson</title>

    <link rel="stylesheet" th:href="@{/css/course_detail.css}">
    <link rel="stylesheet" th:href="@{/css/lesson_detail.css}">
    <link rel="stylesheet" th:href="@{/css/quiz.css}">
</head>
<body>

<header th:replace="fragments/header :: header(loggedIn=${loggedIn}, user=${user})"></header>

<div class="page-container">

    <div class="lesson-top">
        <a class="back-link"
           th:href="@{'/course/' + ${course.idKhoaHoc}}">
            &lt; Back to
            <span th:text="${course.tenKhoaHoc}"></span>
        </a>

        <div class="lesson-header">
            <h1 th:text="${lesson.tieuDeBaiHoc}"></h1>
            <p class="muted" th:text="${lesson.moTaBaiHoc}"></p>

            <div class="pill-row">
                <span class="pill" th:text="'Lesson ' + ${lesson.thuTu}"></span>
            </div>
        </div>

        <div class="nav-row">
            <a class="nav-btn"
               th:if="${prevLesson != null}"
               th:href="@{'/lesson/' + ${prevLesson.idBaiHoc}}">&lt;&lt; Prev</a>
            <a class="nav-btn primary"
               th:if="${nextLesson != null}"
               th:href="@{'/lesson/' + ${nextLesson.idBaiHoc}}">Next &gt;&gt;</a>
            <a class="nav-btn lock"
               th:if="${nextLesson == null and trialMode}"
               th:href="@{'/course/' + ${course.idKhoaHoc} + '?openChatbot=1'}">Unlock full course</a>
        </div>
    </div>

    <!-- TYPE 1: THEORY -->
    <section class="lesson-card" th:if="${lesson.loai == 1}">
        <div class="content" th:text="${lesson.noiDungBaiHoc}">
        </div>
    </section>

    <!-- TYPE 3: VIDEO -->
    <div th:if="${lesson.loai == 3}"
         th:replace="~{fragments/lesson_detail/video :: video(${lesson}, ${trialMode})}">
    </div>

    <!-- TYPE 1,2,3: QUIZ (nếu có) -->
    <div th:if="${lesson.loai != 4}"
         th:replace="~{fragments/lesson_detail/quiz :: quiz(${quiz})}">
    </div>

    <!-- TYPE 4: CODE -->
    <section class="lesson-card" th:if="${lesson.loai == 4}">
        <h2>Code practice</h2>

        <div class="problem">
            <h3>Problem</h3>
            <pre class="pre" th:text="${lesson.codeDeBai}"></pre>
        </div>

        <div class="editor">
            <h3>Starter code</h3>
            <textarea id="codeEditor" class="code-area" th:text="${lesson.starterCode}"></textarea>

            <div class="hint-box" th:if="${lesson.codeGoiY != null}">
                <button class="btn-secondary" type="button" id="btnToggleHint">Show hint</button>
                <div id="hintContent" class="hidden">
                    <pre class="pre" th:text="${lesson.codeGoiY}"></pre>
                </div>
            </div>
        </div>

        <div class="output">
            <h3>Your output</h3>
            <textarea id="userOutput" class="out-area" placeholder="Paste your program output here..."></textarea>

            <button class="btn-primary" type="button" id="btnSubmitCode">Submit</button>
            <div id="codeResult" class="hint hidden"></div>
        </div>
    </section>

    <form th:if="${!trialMode}" method="post" th:action="@{'/lesson/' + ${lesson.idBaiHoc} + '/complete'}">
        <button class="btn-primary" type="submit">Finish lesson</button>
    </form>
</div>

<div id="popup" class="overlay hidden">
    <div class="popup-box" style="max-width:420px">
        <div class="popup-header">
            <span id="title"></span>
            <button id="closePopup">✕</button>
        </div>

        <div class="popup-content">
            <p id="message" style="line-height:1.5">
                You haven't answered all the questions.
            </p>
        </div>
    </div>
</div>

<script th:inline="javascript">
    window.__LESSON_ID__ = [[${lesson.idBaiHoc}]];
</script>

<script th:src="@{/js/lesson_detail.js}"></script>

</body>
</html>
