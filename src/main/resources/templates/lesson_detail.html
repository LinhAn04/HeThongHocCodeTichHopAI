<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title th:text="${lesson.tieuDeBaiHoc} + ' - ' + ${course.tenKhoaHoc}">Lesson</title>

    <link rel="stylesheet" th:href="@{/css/student/courses/course_detail.css}">
    <link rel="stylesheet" th:href="@{/css/student/lessons/lesson_detail.css}">
    <link rel="stylesheet" th:href="@{/css/student/lessons/quiz.css}">
    <link rel="stylesheet" th:href="@{/css/student/lessons/code_challenge.css}">
</head>
<body>

<header th:replace="fragments/header :: header(loggedIn=${loggedIn}, user=${user})"></header>

<div class="page-container">

    <div class="lesson-top">
        <a class="back-link"
           th:href="@{'/course/' + ${course.idKhoaHoc}}">
            &lt; Back to
            <span th:text="${course.tenKhoaHoc}"></span>
        </a>

        <div class="lesson-header">
            <h1 th:text="${lesson.tieuDeBaiHoc}" th:if="${lesson.loai != 4}"></h1>
            <p class="muted" th:text="${lesson.moTaBaiHoc}" th:if="${lesson.loai != 4}"></p>

            <div class="pill-row">
                <span class="pill" th:text="'Lesson ' + ${lessonIndex}"></span>
            </div>
        </div>

        <div class="nav-row">
            <a class="nav-btn"
               th:if="${prevLesson != null}"
               th:href="@{'/lesson/' + ${prevLesson.idBaiHoc}}">&lt;&lt; Prev</a>
            <a class="nav-btn primary"
               th:if="${nextLesson != null}"
               th:href="@{'/lesson/' + ${nextLesson.idBaiHoc}}">Next &gt;&gt;</a>
            <a class="nav-btn lock"
               th:if="${nextLesson == null and trialMode}"
               href="/login">Unlock full course</a>
        </div>
    </div>

    <!-- TYPE 1: THEORY -->
    <section class="lesson-card" th:if="${lesson.loai == 1}">
        <div id="lessonContent" th:text="${lesson.noiDungBaiHoc}">
        </div>
    </section>

    <!-- TYPE 3: VIDEO -->
    <div th:if="${lesson.loai == 3}"
         th:replace="~{fragments/lesson_detail/video :: video(${lesson}, ${trialMode})}">
    </div>

    <!-- TYPE 1,2,3: QUIZ (nếu có) -->
    <div th:if="${lesson.loai != 4}"
         th:replace="~{fragments/lesson_detail/quiz :: quiz(${quiz})}">
    </div>

    <!-- TYPE 4: CODE -->
    <div th:if="${lesson.loai == 4}"
         th:replace="fragments/course_detail/code :: code(${lesson})">
    </div>

    <form th:if="${!trialMode}" method="post" th:action="@{'/lesson/' + ${lesson.idBaiHoc} + '/complete'}">
        <button class="btn-primary" type="submit">Finish lesson</button>
    </form>
</div>

<div id="popup" class="overlay hidden">
    <div class="popup-box" style="max-width:420px">
        <div class="popup-header">
            <span id="title"></span>
            <button id="closePopup">✕</button>
        </div>

        <div class="popup-content">
            <p id="message" style="line-height:1.5">
                You haven't answered all the questions.
            </p>
        </div>
    </div>
</div>

<script th:inline="javascript">
    window.__LESSON_ID__ = [[${lesson.idBaiHoc}]];
</script>

<script th:src="@{/js/lesson_detail.js}"></script>
<script th:src="@{/js/code_challenge.js}"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const el = document.getElementById("lessonContent");
        if (!el) return;

        let text = el.innerText;

        // escape HTML
        text = text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");

        // replace \n (literal)
        text = text.replace(/\\n\\n/g, "<br><br>");
        text = text.replace(/\\n/g, "<br>");

        // bold
        text = text.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");

        el.innerHTML = text;
    });
</script>

</body>
</html>
