<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>OTP verification - AI Code Learning</title>
  <link rel="stylesheet" th:href="@{/css/otp_verify.css}">
</head>

<body class="otp-page">

<div class="otp-wrapper d-flex align-items-center justify-content-center">
  <div class="otp-card">

    <h1 class="title">OTP code</h1>

    <p class="subtitle" th:if="${mode == 'register'}">
      Enter the OTP code sent to your email to verify your account.
    </p>

    <p class="subtitle" th:if="${mode == 'reset'}">
      Enter the OTP code sent to your email to reset password.
    </p>

    <form th:with="actionUrl=${mode == 'register'
                          ? '/api/auth/verify-register'
                          : '/api/auth/verify-reset-pass'}"
          th:action="@{${actionUrl}}"
          method="post"
          onsubmit="return validateOtp(event)">

      <input type="hidden" name="email" th:value="${email}"/>

      <div class="otp-inputs mb-3">
        <input maxlength="1" class="otp-box" autocomplete="off"
               th:classappend="${error != null} ? ' error-field' : ''">
        <input maxlength="1" class="otp-box" autocomplete="off"
               th:classappend="${error != null} ? ' error-field' : ''">
        <input maxlength="1" class="otp-box" autocomplete="off"
               th:classappend="${error != null} ? ' error-field' : ''">
        <input maxlength="1" class="otp-box" autocomplete="off"
               th:classappend="${error != null} ? ' error-field' : ''">
        <input maxlength="1" class="otp-box" autocomplete="off"
               th:classappend="${error != null} ? ' error-field' : ''">
        <input maxlength="1" class="otp-box" autocomplete="off"
               th:classappend="${error != null} ? ' error-field' : ''">
      </div>

      <input type="hidden" id="otp-hidden-code" name="code">

      <div id="otp-error-popup"
           th:class="'error ' + (${error} != null ? '' : 'hidden')">
      <span th:text="${error}"></span>
      </div>

      <div id="otp-success"
           class="message"
           th:if="${message}"
           th:text="${message}"></div>

      <div class="btn-row">
        <a th:if="${mode == 'register'}"
           th:href="@{/api/auth/resend-register(email=${email})}"
           class="btn btn-resend">Resend OTP</a>

        <a th:unless="${mode == 'register'}"
           th:href="@{/api/auth/resend-reset-pass(email=${email})}"
           class="btn btn-resend">Resend OTP</a>

        <button type="submit" class="btn-next">Next</button>
      </div>
    </form>

  </div>
</div>

<script>
  const boxes = document.querySelectorAll(".otp-box");

  boxes.forEach((box, index) => {
    box.addEventListener("input", (e) => {
      let value = box.value;

      if (!/^[0-9]$/.test(value)) {
        box.value = "";
        return;
      }

      if (value && index < boxes.length - 1) {
        boxes[index + 1].focus();
      }
    });

    box.addEventListener("keydown", (e) => {
      if (e.key === "Backspace" && box.value === "" && index > 0) {
        boxes[index - 1].focus();
      }
    });

    box.addEventListener("paste", (e) => {
      e.preventDefault();
      let paste = (e.clipboardData || window.clipboardData).getData("text");
      paste = paste.replace(/\D/g, "").substring(0, 6);

      for (let i = 0; i < paste.length && i < boxes.length; i++) {
        boxes[i].value = paste[i];
      }

      boxes[Math.min(paste.length, 5)].focus();
    });
  });

  function showOtpError(msg) {
    const popup = document.getElementById("otp-error-popup");
    popup.classList.remove("hidden");
    popup.querySelector("span").textContent = msg;

    // Ẩn message BE nếu đang tồn tại
    const success = document.getElementById("otp-success");
    if (success) success.style.display = "none";
  }

  function hideOtpError() {
    const popup = document.getElementById("otp-error-popup");
    popup.classList.add("hidden");
  }

  function validateOtp(event) {
    const boxes = document.querySelectorAll(".otp-box");

    hideOtpError();
    boxes.forEach(b => b.classList.remove("error-field"));

    let empty = false;
    boxes.forEach(b => { if (!b.value.trim()) empty = true; });

    if (empty) {
      event.preventDefault();
      boxes.forEach(b => b.classList.add("error-field"));
      showOtpError("OTP cannot be empty.");

      const success = document.getElementById("otp-success");
      if (success) success.style.display = "none";

      return false;
    }

    let code = "";
    boxes.forEach(b => code += b.value);
    document.getElementById("otp-hidden-code").value = code;

    return true;
  }

  document.querySelectorAll(".otp-box").forEach(box => {
    box.addEventListener("input", () => {
      hideOtpError();

      const success = document.getElementById("otp-success");
      if (success) success.style.display = "none";
    });
  });

  document.querySelectorAll(".otp-box").forEach(box => {
    box.addEventListener("input", () => {
      hideOtpError();

      // Xóa viền đỏ của tất cả các ô
      document.querySelectorAll(".otp-box")
              .forEach(b => b.classList.remove("error-field"));
    });
  });

</script>

</body>
</html>
