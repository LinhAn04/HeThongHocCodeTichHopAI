<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<body>

<section id="comments"
         class="tab-panel"
         th:fragment="comments(
             comments,
             repliesMap,
             course,
             loggedIn
         )">

    <h2>Comments</h2>

    <!-- POST COMMENT -->
    <div class="comment-box" th:if="${loggedIn}">
        <form method="post"
              th:action="@{'/course/' + ${course.idKhoaHoc} + '/comment'}">

            <div class="comment-input-container">
            <textarea name="noiDung"
                      placeholder="Write a comment..."
                      required></textarea>

                <button type="submit"
                        class="send-btn"
                        title="Post comment">
                    ➤
                </button>
            </div>
        </form>
    </div>

    <!-- COMMENT LIST -->
    <div class="comment" th:each="c : ${comments}">

        <!-- HEADER -->
        <div class="comment-head">
            <img class="avatar"
                 th:src="@{${c.nguoiDung.avatar != null
                     ? c.nguoiDung.avatar
                     : '/images/avatar_user_default.png'}}"/>

            <div class="comment-meta">
                <div class="name" th:text="${c.nguoiDung.hoTen}"></div>
                <div class="time"
                     th:text="${#temporals.format(c.thoiGianDanhGia,'dd/MM/yyyy HH:mm')}"></div>
            </div>

            <!-- MORE -->
            <div class="comment-menu"
                 th:if="${c.canEdit}"
                 th:attr="data-id=${c.idDanhGia}">⋯

                <div class="menu-dropdown hidden">

                    <div class="menu-item edit-comment"
                         th:attr="data-id=${c.idDanhGia}">
                        Edit
                    </div>

                    <form method="post"
                          class="delete-form"
                          th:attr="data-type='comment'"
                          th:action="@{'/comment/' + ${c.idDanhGia} + '/delete'}">
                        <div class="menu-item delete">
                            Delete
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- BODY -->
        <div class="comment-body"
             th:text="${c.noiDungDanhGia}"></div>

        <form class="edit-form hidden"
              th:attr="id='edit-comment-form-' + ${c.idDanhGia}"
              method="post"
              th:action="@{'/comment/' + ${c.idDanhGia} + '/edit'}">

            <div class="reply-input-container">
        <textarea name="noiDung"
                  th:text="${c.noiDungDanhGia}"
                  required></textarea>

                <button type="submit" class="send-btn">➤</button>
            </div>
        </form>

        <!-- ACTIONS -->
        <div class="comment-actions">
            <span class="edited-link"
                  th:if="${c.soLanChinhSua > 0}"
                  th:attr="data-id=${c.idDanhGia}">
                edited
            </span>

            <span class="reply-toggle"
                  th:if="${loggedIn}"
                  th:attr="data-id=${c.idDanhGia}">
                Reply
            </span>
        </div>

        <!-- VIEW REPLIES -->
        <div class="view-replies"
             th:if="${#lists.size(repliesMap[c.idDanhGia]) > 0}"
             th:attr="data-id=${c.idDanhGia}">
            View all <span th:text="${#lists.size(repliesMap[c.idDanhGia])}"></span> replies
        </div>

        <!-- REPLIES -->
        <div class="reply-list hidden"
             th:attr="id='replies-' + ${c.idDanhGia}">

            <div class="reply"
                 th:each="r : ${repliesMap[c.idDanhGia]}">

                <div class="reply-head">
                    <img class="avatar small"
                         th:src="@{${r.nguoiDung.avatar != null
                             ? r.nguoiDung.avatar
                             : '/images/avatar_user_default.png'}}"/>

                    <div class="reply-meta">
                        <div class="name" th:text="${r.nguoiDung.hoTen}"></div>
                        <div class="time"
                             th:text="${#temporals.format(r.thoiGianPhanHoi,'dd/MM/yyyy HH:mm')}"></div>
                    </div>

                    <div class="comment-menu"
                         th:if="${r.canEdit}"
                         th:attr="data-id=${r.idPhanHoiDanhGia}">⋯

                        <div class="menu-dropdown hidden">

                            <div class="menu-item edit-reply"
                                 th:attr="data-id=${r.idPhanHoiDanhGia}">
                                Edit
                            </div>

                            <form method="post"
                                  class="delete-form"
                                  th:attr="data-type='reply'"
                                  th:action="@{'/reply/' + ${r.idPhanHoiDanhGia} + '/delete'}">
                                <div class="menu-item delete">
                                    Delete
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="reply-body"
                     th:text="${r.noiDungPhanHoi}"></div>

                <div class="comment-actions">
                    <span class="edited-link"
                          th:if="${r.soLanChinhSua > 0}"
                          th:attr="data-id=${r.idPhanHoiDanhGia}">
                        edited
                    </span>
                </div>

                <form class="edit-form hidden"
                      th:attr="id='edit-reply-form-' + ${r.idPhanHoiDanhGia}"
                      method="post"
                      th:action="@{'/reply/' + ${r.idPhanHoiDanhGia} + '/edit'}">

                    <div class="reply-input-container">
                    <textarea name="noiDung"
                              th:text="${r.noiDungPhanHoi}"
                              required></textarea>

                        <button type="submit" class="send-btn">➤</button>
                    </div>
                </form>

                <!-- REPLY EDIT HISTORY SOURCE -->
                <div class="hidden"
                     th:id="'history-' + ${r.idPhanHoiDanhGia}">
                    <div th:each="h : ${r.lichSuChinhSua}">
                        <div class="history-item">
                            <div class="history-content"
                                 th:text="${h.noiDungCu}"></div>
                            <div class="history-time"
                                 th:text="${#temporals.format(h.thoiGianChinhSua,'dd/MM/yyyy HH:mm')}"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- REPLY FORM -->
        <form class="reply-form hidden"
              th:if="${loggedIn}"
              th:attr="id='reply-form-' + ${c.idDanhGia}"
              method="post"
              th:action="@{'/comment/' + ${c.idDanhGia} + '/reply'}">

            <div class="reply-input-container">
                <textarea name="noiDung"
                          placeholder="Write a reply..."
                          required></textarea>

                <button type="submit"
                        class="send-btn"
                        title="Send">➤</button>
            </div>
        </form>

        <!-- COMMENT EDIT HISTORY SOURCE -->
        <div class="hidden"
             th:id="'history-' + ${c.idDanhGia}">
            <div th:each="h : ${c.lichSuChinhSua}">
                <div class="history-item">
                    <div class="history-content"
                         th:text="${h.noiDungCu}"></div>
                    <div class="history-time"
                         th:text="${#temporals.format(h.thoiGianChinhSua,'dd/MM/yyyy HH:mm')}"></div>
                </div>
            </div>
        </div>
    </div>
</section>

</body>
</html>
