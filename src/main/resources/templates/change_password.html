<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Reset password - AI Code Learning</title>
    <link rel="stylesheet" th:href="@{/css/change_password.css}">
</head>

<body class="login-page">

<div class="login-wrapper d-flex align-items-center justify-content-center">

    <div class="login-card text-white">

        <h1 class="login-title mb-4">Reset password</h1>

        <form th:action="@{/api/auth/change-password}" method="post" onsubmit="return validateChangePassForm(event)">

            <input type="hidden" name="email" th:value="${email}">

            <!-- New password -->
            <div class="password-wrapper">
                <input type="password"
                       id="newPassword"
                       name="newPassword"
                       class="form-control-custom"
                       placeholder="New password">
                <span class="toggle-password" data-target="newPassword">
                    <img src="/images/eye_hidepass.png">
                </span>
            </div>

            <!-- Confirm new password -->
            <div class="password-wrapper">
                <input type="password"
                       id="confirmPassword"
                       name="confirmPassword"
                       class="form-control-custom"
                       placeholder="Re-enter new password">
                <span class="toggle-password" data-target="confirmPassword">
                    <img src="/images/eye_hidepass.png">
                </span>
            </div>

            <div id="change-error-popup"
                 class="login-error-popup"
                 th:classappend="${error != null} ? '' : ' hidden'"
                 th:text="${error}">
            </div>

            <button type="submit" class="btn-sign-in mt-3">
                Next
            </button>

        </form>

    </div>
</div>

<script>
    // Toggle password visibility
    document.querySelectorAll(".toggle-password").forEach(icon => {
        icon.addEventListener("click", () => {
            const target = document.getElementById(icon.dataset.target);
            const isHidden = target.type === "password";
            target.type = isHidden ? "text" : "password";

            const img = icon.querySelector("img");
            img.src = isHidden ? "/images/eye_seepass.png" : "/images/eye_hidepass.png";
        });
    });

    function showError(msg) {
        const popup = document.getElementById("change-error-popup");
        popup.textContent = msg;
        popup.classList.remove("hidden");
    }

    function hideError() {
        const popup = document.getElementById("change-error-popup");
        popup.classList.add("hidden");
    }

    // FE validation
    function validateChangePassForm(event) {
        hideError();

        const newPass = document.getElementById("newPassword");
        const confirmPass = document.getElementById("confirmPassword");

        newPass.classList.remove("error-field");
        confirmPass.classList.remove("error-field");

        if (!newPass.value.trim()) {
            newPass.classList.add("error-field");
            showError("Password cannot be empty.");
            event.preventDefault();
            return false;
        }

        if (!confirmPass.value.trim()) {
            confirmPass.classList.add("error-field");
            showError("Please confirm your password.");
            event.preventDefault();
            return false;
        }

        const strongPasswordRegex =
            /^(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&#^()_+\-={}\[\]|:;'"<>,./~`]).{8,}$/;

        if (!strongPasswordRegex.test(newPass.value)) {
            newPass.classList.add("error-field");
            showError(
                "Password must be at least 8 characters long, contain at least one uppercase letter, one number, and one special character."
            );
            event.preventDefault();
            return false;
        }

        if (newPass.value !== confirmPass.value) {
            confirmPass.classList.add("error-field");
            showError("Passwords do not match.");
            event.preventDefault();
            return false;
        }

        return true;
    }

    // Remove error on input
    document.querySelectorAll("input").forEach(input => {
        input.addEventListener("input", () => {
            input.classList.remove("error-field");
            hideError();
        });
    });
</script>

</body>
</html>
